# 网络编程

## 一、网络通信原理

### 1、互联网的本质就是一系列的网络协议
每台设备都是孤立的，现在需要信息交互

需要统一的通信标准去定义计算机如果接入Internet：  

Internet Protocol Suite 互联网协议

### 2、五层协议

应用层

传输层 --- 四层交换机、四层路由器

网络层 --- 路由器、三层交换机

数据量链路层 --- 网桥、交换机、网卡

物理层 --- 中继器、集线器

#### 2.1、物理层

双绞线、电缆、光缆、无线电波

基于电器特性发送的高低压电信号，高电压对应数字1，低电压对应数字0

#### 2.2、数据链路层

由来：单纯0和1没有意义，必须规定电信号多少位为一组，每组的意义

功能：定义了电信号的分组方式

###### 以太网协议ethernet：

- 一组电信号构成一个数据包，叫做‘帧’
- 每一数据帧分成：报头head 和 数据data两部分

head 包括：（固定18个字节）
  
- 发送者/源地址：6个字节 
- 接受者/目标地址：6个字节
- 数据类型：6个字节

data : 最短46个字节， 最长1500字节

head + data =最短64 最长1518，超过最大字节数就分片发送

##### mac :

每块网卡出厂的时候生成的唯一地址 12位16进制

该mac地址就是head 中发送者和接受者的地址

##### 广播：

通过ARP协议同一网络内的两台主机通信

###### ARP协议：

Adress Solution Protocol 根据IP地址获取物理地址的一个TCP/IP协议。
主机发送信息时，将包含目标ip地址的ARP 请求广播到网络上，并接受返回的信息，确定目标的物理地址，之后就会将ip地址和mac地址绑定保存到缓存中。

#### 2.3、网络层

有了上述的两层，彼此隔离局域网可以相互通信了。

但是机器如此之多，通过以太网的广播形式发送信息，效率如此之低，而且以太网包只能在同一个局域网内发送，不可能把全世界机器都通过物理层连接到一起。所以有了网络地址，用于区分不同的广播域/子网，一个局域网是一个广播域，不同广播域需要路由转发。

###### IP协议：
- 规定网络地址的协议叫IP协议，它定义的地址称之为ip地址，广泛采用ipv4
- 范围0.0.0.0 - 255.255.255.255

###### IP地址：
- 网络部分：识别子网
- 主机部分：识别主机

###### 子网掩码：

表示网络特征的一个参数。形式上等同于IP，网络部分全是1，主机部分为0，所以是255.255.255.0，同于与ip地址的与运算（二进制）得出是否在同一子网。


###### ip数据包：
放入以太网的data部分

head:长度在20到60个字节


data:最长65516字节

###### ARP协议过程：

1. 通过ip地址子网掩码区分自己和目标所在子网
2. 发送[源mac|目标mac(如果不在同一子网mac就是网关的mac)（未获取）|源IP|目标IP|数据]
3. 这个包以广播的方式在自己子网内发送，所有主机拆包后，发现目标ip是自己的ip就返回自己的mac

#### 2.4 传输层

由来：网络层的ip和数据链路层的ethernet协议找到的mac地址，两者可以找到特定的计算机，怎样识别计算机上面的程序，就要靠端口号，端口号就是计算机和网卡之间的关联编号。

0-1023是系统占用的，其余-65535是用户可用的

##### TCP协议：

可靠传输

三次握手

客户端随机生成一个序列号，带着这个序列号发送给服务器，服务器获取这个序列号之后加1，然后自己又生成一个随机序列号，带着这两个值返回给客户端，客户端收到自己发送的值+1的值，就可以确认服务器可以收到自己发送的消息，然后把服务器发送的随机序列号+1，再发送给服务器，服务收到后，确认客户端可以收到自己发送的信息，并建立连接。

传输数据

断开连接四次挥手

客户端发送FIN报文给服务器，服务器返回一个消息说，让客户端先等等，等到我发送FIN报文才终端。


#### 2.5 应用层



#### 2.3.1 socket

应用层和传输层之间的抽象层，封装了TCP/IP复杂的操作，抽象为供应用层调用的接口，本质就是打开-读/写-关闭


## 三、网络通信的实现

所需要的信息：
1. IP地址
2. 子网掩码
3. 网关
4. DNS

方法1：手动
方法2：通过DHCP服务器获取

新加入局域网的计算机广播发送一个数据包，

数据包结构：

	以太网头：自己的mac地址，
			目标的mac地址（未知就填写广播地址FF:FF:FF:FF:FF:FF）
	IP头：自己的IP未知填写0.0.0.0
		  目标IP未知255.255.255.255
	UPD头：端口号
	DHCP数据包

因为是广播发送，局域网内其他计算机拆包后发现不是发送给自己的，只有DHCP服务器能接收到，就把IP地址、子网掩码、网关DNS信息放到DHCP数据包中返回给计算机。



